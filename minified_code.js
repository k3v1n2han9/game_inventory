// ==UserScript==
// @name         game_inventory
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @match        https://admin.shopify.com/store/boardgame-master/*
// @grant        none
// ==/UserScript==


let in_inventory_page=location.href.includes("admin/products/inventory"),in_batch_editing_page=location.href.includes("admin/bulk"),in_product_page=location.href.includes("admin/products")&&!in_inventory_page;function refreshData(){let a=location.href.includes("admin.shopify.com/store/boardgame-master/products/inventory"),b=location.href.includes("admin.shopify.com/store/boardgame-master/bulk"),c=location.href.includes("admin.shopify.com/store/boardgame-master/products")&&!a,d="https://game.kevinzhang.info/check-game/";if(console.log("refresh"),b)console.log("\u6279\u91CF\u4FEE\u6539\u9875\u9762"),setTimeout(()=>{$(".spreadsheet__row").each(function(){let a=$(this),b=a.find("#product_variant_sku").val();if(console.log(b),b){let c=new XMLHttpRequest;c.onreadystatechange=function(){if(4===this.readyState&&200===this.status){let b=JSON.parse(this.response),c=a.find(".variant-option-value"),d=c.html();b.price?(d+="<span style=\"color:blue\">($"+b.price+")</span>",c.html(d)):(d+="<span style=\"color:red\">("+b.status+")</span>",c.html(d))}};let e=d+b;e=encodeURI(e),c.open("GET",e,!0),c.send()}})},2e3);else if(a){function a(a){console.log("\u53D1\u9001\u8BF7\u6C42");let b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===this.readyState&&200===this.status){let b=JSON.parse(this.response),c=e.find(b=>b.sku===a),d="color:blue";"Order Now"!==b.status&&(d="color:red;font-weight:bold"),c.elem.innerHTML+="<br><span class=\"inventory-status\" style=\""+d+"\"> ("+b.status+")</span>"}};let c=d+a;c=encodeURI(c),b.open("GET",c,!0),b.send()}console.log("\u5E93\u5B58\u4E3B\u9875\u9762");let b=document.getElementsByClassName("inventory-status");for(let a=0;a<b.length;a++)b[a].style.display="none";let c=document.getElementsByClassName("_Sku_gfy7s_1"),e=[];for(let a=0;a<c.length;a++)e.push({elem:c[a],sku_with_plus:c[a].innerText});e.forEach(b=>{let c=b.sku_with_plus;if(c.includes("+")){let a=c.split("+");c=a[a.length-1]}b.sku=c,a(b.sku)})}else{console.log("\u4EA7\u54C1\u9875");let a=document.getElementsByClassName("Polaris-Header-Title")[0],b=document.getElementsByClassName("Polaris-Page-Header__TitleWrapper")[0],c=a.innerText,e=document.getElementById("InventoryCardSku").value;e.includes("+")&&(e=e.split("+"),e=e[e.length-1]);let f=new XMLHttpRequest;f.onreadystatechange=function(){if(4===this.readyState&&200===this.status){let a=JSON.parse(this.response),d=a.status;b.innerHTML+="<h1><span style=\"color:red\">("+a.status+")</span><br><a target=\"_blank\" href=\"https://vrdistribution.com.au/search?q="+e+"\">\u4F9B\u5E94\u5546\u7F51\u7AD9\uFF08VR\uFF09<br><a target=\"_blank\" href=\"https://letsplaygames.com.au/catalogsearch/result/?q="+e+"\">\u4F9B\u5E94\u5546\u7F51\u7AD9\uFF08Let's Play\uFF09</a></h1>";let f=document.getElementsByClassName("Polaris-Label__Text")[0],g=document.getElementById("CollectionsAutocompleteField1Label"),h=document.getElementById("InventoryCardSkuLabel"),i=document.getElementById("product-descriptionLabel");if([{name:"title",elem:f},{name:"collection",elem:g},{name:"sku",elem:h},{name:"description",elem:i}].forEach(a=>{a.elem||console.log(a.name,"\u574F\u4E86")}),d.includes("Arriving Soon")||d.includes("Pre Order")){f.innerHTML+=mergeString(`<a href="javascript:copyText('【Pre-Order】')">复制</a>`,{game_title:c}),g.innerHTML+=`<br><a href="javascript:copyText('Pre-Order')">复制Pre-Order</a>`,"Pre Order"===d&&(g.innerHTML+=`<br><a href="javascript:copyText('Early Bird Discount')">复制Early Bird Discount</a>`);let b,e=a.date.split(" ").filter(b=>b),j="";3===e.length?(j=e[0].substring(0,e[0].length-2),b=`<p> <strong> Please read our pre-order policy at the foot of the webpage before ordering (It is important when you want the order sent separately). </strong></p><p> <span style="color: rgb(255, 0, 0);" data-mce-style="color: #ff0000;"> <strong> Please be aware that the following product is a pre-order and is expected to be released/(Re)stocked in&nbsp;{{arrival}}. </strong> </span></p><p> <span style="color: rgb(255, 0, 0);" data-mce-style="color: #ff0000;"> <strong> As our supplier hasn’t provided a detailed release/restock date, so it is likely to delay. Thus, we strongly recommend you to order this item separately with all other items to avoid the possible late dispatch of the whole order. </strong> </span></p><br><br><br><br>`):b=`<p> <strong> Please read our pre-order policy at the foot of the webpage before ordering (It is important when you want the order sent separately). </strong></p><p> <span style="color: rgb(255, 0, 0);" data-mce-style="color: #ff0000;"> <strong> Please be aware that the following product is a pre-order and is expected to be released/(Re)stocked in&nbsp;{{arrival}}. </strong> </span></p><p> <span style="color: rgb(255, 0, 0);" data-mce-style="color: #ff0000;"> <strong> As our supplier hasn’t provided a detailed release/restock date, so it is likely to delay. Thus, we strongly recommend you to order this item separately with all other items to avoid the possible late dispatch of the whole order. </strong> </span></p><br><br><br><br>`;let k=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],l=["","January","February","March","April","May","June","July","August","September","October","November","December"],m=k.indexOf(e[e.length-2]);10>+m&&(m="0"+m),j&&10>+j&&(j="0"+j);let n,o;if(j)o=new Date(new Date(e[e.length-1]+"-"+m+"-"+j+" 00:00:00").getTime()+2419200000),n="9999"+m+j+a.num_on,o=o.getDate()+" "+l[o.getMonth()+1]+" "+o.getFullYear();else if(0===e.length)o="(unknown)";else{o=l[k.indexOf(e[0])]+"&nbsp;"+e[1].substring(0,4);let a=new Date(new Date(o).getTime()+2764800000);a=l[a.getMonth()+1]+" "+a.getFullYear(),o=a}n+="+",h.innerHTML+=mergeString(`<a href="javascript:copyText('{{new_sku}}')">复制</a>`,{new_sku:n});let p=mergeString(b,{arrival:o});i.innerHTML+="<br>\u624B\u52A8\u590D\u5236\u7C98\u8D34\u4EE5\u4E0B\u5185\u5BB9<br><div style=\"background-color: lightgray\">"+p+"</div>"}}};let g=d+e;g=encodeURI(g),f.open("GET",g,!0),f.send()}}let is_loading=!1,loading_icon_count=-1,interval=setInterval(()=>{let a=document.getElementsByClassName("Polaris-Header-Title");0<a.length&&(a=a[0],a.removeEventListener("click",refreshData),a.addEventListener("click",refreshData))},1e3);function mergeString(a,b){for(;a.includes("{{");){let c=a.split("{{")[1].split("}}")[0];a=a.replace("{{"+c+"}}",b[c])}return a}function copyText(a){let b=document.createElement("input");b.style.transform="scale(0.1)",document.body.appendChild(b),b.value=a,b.select(),b.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(b)}let s1=document.createElement("script");s1.appendChild(document.createTextNode(copyText)),(document.body||document.head||document.documentElement).appendChild(s1);let s2=document.createElement("script");s2.appendChild(document.createTextNode(mergeString)),(document.body||document.head||document.documentElement).appendChild(s2);let s3=document.createElement("script");s3.appendChild(document.createTextNode(refreshData)),(document.body||document.head||document.documentElement).appendChild(s3);